<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loan Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

  <div class="w-full max-w-md bg-white p-6 rounded-xl shadow-lg">
    <h1 class="text-2xl font-bold text-center mb-4">Loan Tracker</h1>

    <!-- Auth Section -->
    <div id="auth-section" class="space-y-3">
      <input id="email" type="email" placeholder="Email" class="w-full p-2 border rounded">
      <input id="password" type="password" placeholder="Password" class="w-full p-2 border rounded">
      <button id="signup-btn" class="w-full bg-green-500 text-white py-2 rounded">Sign Up</button>
      <button id="login-btn" class="w-full bg-blue-500 text-white py-2 rounded">Login</button>
      <p id="auth-error" class="text-red-500 text-sm"></p>
    </div>

    <!-- Loan Section -->
    <div id="loan-section" class="hidden space-y-4">
      <div class="flex justify-between items-center">
        <h2 class="text-lg font-semibold">Loans</h2>
        <button id="logout-btn" class="bg-red-500 text-white px-3 py-1 rounded">Logout</button>
      </div>

      <!-- Add Loan -->
      <input id="borrower-name" type="text" placeholder="Borrower Name" class="w-full p-2 border rounded">
      <input id="loan-amount" type="number" placeholder="Amount" class="w-full p-2 border rounded">
      <button id="add-loan-btn" class="w-full bg-blue-500 text-white py-2 rounded">Add Loan</button>

      <!-- Search -->
      <input id="search-input" type="text" placeholder="Search borrower..." class="w-full p-2 border rounded">

      <!-- Summary -->
      <div class="bg-gray-100 p-3 rounded-md">
        <p><strong>Active Loans:</strong> <span id="totalActive">0</span></p>
        <p><strong>Total Loaned:</strong> <span id="totalLoaned">0</span></p>
        <p><strong>Total Paid:</strong> <span id="totalPaid">0</span></p>
      </div>

      <!-- Loan List -->
      <ul id="loan-list" class="space-y-3"></ul>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ðŸ”¹ Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBlpcrpLA14LKvQy_G5GELJNIeG9Sn_yIk",
  authDomain: "loan-tracker-app-d7e0c.firebaseapp.com",
  projectId: "loan-tracker-app-d7e0c",
  storageBucket: "loan-tracker-app-d7e0c.firebasestorage.app",
  messagingSenderId: "958201169143",
  appId: "1:958201169143:web:35803b69eb0d18a7a17ff2",
  measurementId: "G-Q67R68ZWZ3"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    enableIndexedDbPersistence(db).catch(() => console.warn("Persistence unavailable"));

    // ðŸ”¹ Elements
    const authSection = document.getElementById("auth-section");
    const loanSection = document.getElementById("loan-section");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const signupBtn = document.getElementById("signup-btn");
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const authErrorEl = document.getElementById("auth-error");
    const borrowerInput = document.getElementById("borrower-name");
    const amountInput = document.getElementById("loan-amount");
    const addLoanBtn = document.getElementById("add-loan-btn");
    const loanList = document.getElementById("loan-list");
    const totalActiveEl = document.getElementById("totalActive");
    const totalLoanedEl = document.getElementById("totalLoaned");
    const totalPaidEl = document.getElementById("totalPaid");
    const searchInput = document.getElementById("search-input");

    let unsubscribeLoans = null;
    let allLoans = []; // store all loans for search

    // ðŸ”¹ Auth Handlers
    signupBtn.onclick = async () => {
      try {
        await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
      } catch (err) {
        authErrorEl.textContent = err.message;
      }
    };

    loginBtn.onclick = async () => {
      try {
        await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
      } catch (err) {
        authErrorEl.textContent = err.message;
      }
    };

    logoutBtn.onclick = async () => { await signOut(auth); };

    // ðŸ”¹ Add Loan
    addLoanBtn.onclick = async () => {
      const borrower = borrowerInput.value.trim();
      const amount = parseFloat(amountInput.value);
      if (!borrower || isNaN(amount)) return alert("Enter valid details");

      const user = auth.currentUser;
      if (!user) return;

      await addDoc(collection(db, "users", user.uid, "loan_records"), {
        borrower, amount, paidAmount: 0, isPaid: false, createdAt: new Date()
      });

      borrowerInput.value = "";
      amountInput.value = "";
    };

    // ðŸ”¹ Listen Auth State
    onAuthStateChanged(auth, (user) => {
      if (user) {
        authSection.classList.add("hidden");
        loanSection.classList.remove("hidden");

        const q = query(collection(db, "users", user.uid, "loan_records"), orderBy("createdAt", "desc"));
        if (unsubscribeLoans) unsubscribeLoans();
        unsubscribeLoans = onSnapshot(q, (snapshot) => {
          allLoans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          renderLoans();
        });
      } else {
        if (unsubscribeLoans) unsubscribeLoans();
        authSection.classList.remove("hidden");
        loanSection.classList.add("hidden");
      }
    });

    // ðŸ”¹ Render Loans
    function renderLoans() {
      const searchText = searchInput.value.toLowerCase();
      const loans = allLoans.filter(l => l.borrower.toLowerCase().includes(searchText));

      loanList.innerHTML = "";
      let totalLoaned = 0, totalPaid = 0, active = 0;

      loans.forEach((loan) => {
        totalLoaned += loan.amount;
        totalPaid += loan.paidAmount;
        if (!loan.isPaid) active += (loan.amount - loan.paidAmount);

        const li = document.createElement("li");
        li.className = "bg-gray-50 p-3 rounded shadow";
        li.innerHTML = `
          <p><strong>${loan.borrower}</strong> - â‚¹${loan.amount}</p>
          <p>Paid: â‚¹${loan.paidAmount} | Remaining: â‚¹${loan.amount - loan.paidAmount}</p>
          <div class="flex space-x-2 mt-2">
            <input type="number" placeholder="Pay amount" class="pay-input p-1 border rounded w-24">
            <button class="pay-btn bg-green-500 text-white px-2 py-1 rounded text-sm">Pay</button>
            <button class="del-btn bg-red-500 text-white px-2 py-1 rounded text-sm">Delete</button>
          </div>
        `;

        li.querySelector(".pay-btn").onclick = async () => {
          const payVal = parseFloat(li.querySelector(".pay-input").value);
          if (!payVal || payVal <= 0) return alert("Enter valid amount");

          const newPaid = loan.paidAmount + payVal;
          await updateDoc(doc(db, "users", auth.currentUser.uid, "loan_records", loan.id), {
            paidAmount: newPaid,
            isPaid: newPaid >= loan.amount
          });
        };

        li.querySelector(".del-btn").onclick = async () => {
          await deleteDoc(doc(db, "users", auth.currentUser.uid, "loan_records", loan.id));
        };

        loanList.appendChild(li);
      });

      totalActiveEl.textContent = "â‚¹" + active;
      totalLoanedEl.textContent = "â‚¹" + totalLoaned;
      totalPaidEl.textContent = "â‚¹" + totalPaid;
    }

    searchInput.addEventListener("input", renderLoans);

  </script>
</body>
</html>

