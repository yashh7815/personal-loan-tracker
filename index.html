<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Setup Example</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background-color: #f4f7f9; }
        .container { max-width: 600px; margin: 50px auto; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-2xl font-bold text-gray-800 mb-4">Firebase Status</h1>
        <div id="status" class="p-4 bg-yellow-100 text-yellow-800 rounded-lg">Initializing...</div>
    </div>

    <script type="module">
        // 1. Mandatory Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment (MANDATORY USE)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const statusEl = document.getElementById('status');

        async function initializeFirebase() {
            try {
                // Check if config is available
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase config is missing or empty.");
                }

                // Initialize App
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);

                statusEl.className = 'p-4 bg-indigo-100 text-indigo-800 rounded-lg';
                statusEl.innerHTML = 'App initialized. Attempting sign-in...';

                // Sign in using the custom token or anonymously if the token is unavailable
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    statusEl.className = 'p-4 bg-green-100 text-green-800 rounded-lg';
                    statusEl.innerHTML = `✅ Successfully signed in! User ID: <strong>${auth.currentUser.uid}</strong><br>App ID: <strong>${appId}</strong>`;
                } else {
                    // Fallback to anonymous sign-in if the token is not provided
                    await signInAnonymously(auth);
                    statusEl.className = 'p-4 bg-green-100 text-green-800 rounded-lg';
                    statusEl.innerHTML = `✅ Signed in anonymously. User ID: <strong>${auth.currentUser.uid}</strong><br>App ID: <strong>${appId}</strong>`;
                }

                // Now 'db', 'auth', and 'appId' are ready for use.
                console.log("Firebase initialized and user authenticated.");
                // For demonstration, these can be attached to window for easier debugging
                window.db = db;
                window.auth = auth;

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                statusEl.className = 'p-4 bg-red-100 text-red-800 rounded-lg';
                statusEl.textContent = `❌ Initialization Error: ${error.message}`;
            }
        }

        initializeFirebase();
    </script>
</body>
</html>
